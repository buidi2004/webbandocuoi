# ============================================
# IVIE Wedding Studio - Render Blueprint (FIXED)
# ============================================
databases:
  - name: ivie-db-new
    plan: free
    databaseName: ivie_wedding_db
    user: ivie_admin
    region: singapore

services:
  # ============ BACKEND API (FastAPI) ============
  - type: web
    name: ivie-backend-v2 # Đã đổi tên để tránh trùng
    runtime: docker
    plan: free
    region: singapore
    rootDir: backend
    dockerfilePath: ./Dockerfile
    healthCheckPath: /api/health
    envVars:
      - key: DATABASE_URL
        fromDatabase:
          name: ivie-db-new
          property: connectionString
      - key: SECRET_KEY
        generateValue: true
      - key: CORS_ORIGINS
        # Tự động cập nhật dựa trên tên service mới bên dưới
        value: https://ivie-frontend-v2.onrender.com,https://ivie-admin-v2.onrender.com
      - key: PORT
        value: "8000"
      - key: WEB_CONCURRENCY
        value: "1"

  # ============ FRONTEND (Static Site) ============
  - type: web
    name: ivie-frontend-v2 # Đã đổi tên
    runtime: static
    plan: free
    rootDir: frontend
    buildCommand: npm ci && npm run build
    staticPublishPath: ./dist
    routes:
      - type: rewrite
        source: /*
        destination: /index.html
    envVars:
      - key: VITE_API_BASE_URL
        value: https://ivie-backend-v2.onrender.com # Trỏ về Backend mới
      - key: NODE_ENV
        value: production

  # ============ ADMIN PANEL (Streamlit) ============
  - type: web
    name: ivie-admin-v2 # Đã đổi tên
    runtime: docker
    plan: free
    region: singapore
    rootDir: admin-python
    dockerfilePath: ./Dockerfile
    healthCheckPath: /_stcore/health
    envVars:
      - key: API_BASE_URL
        value: https://ivie-backend-v2.onrender.com # Trỏ về Backend mới
      - key: STREAMLIT_SERVER_PORT
        value: "8501"
      - key: STREAMLIT_SERVER_HEADLESS
        value: "true"